name: Public Auto Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'vite.config.js'
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  build-and-deploy:
    name: Build and Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: ğŸ“¥ Checkout LFS objects
        run: git lfs pull
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ” Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          GIT_HASH=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "git_hash=$GIT_HASH" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ”– Commit: $GIT_HASH"
          echo "ğŸ“… Date: $BUILD_DATE"
      
      - name: ğŸ—ï¸ Build application
        env:
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_GIT_HASH: ${{ steps.version.outputs.git_hash }}
          VITE_BUILD_DATE: ${{ steps.version.outputs.build_date }}
        run: |
          echo "Building TRYONYOU v${{ steps.version.outputs.version }}..."
          npm run build
      
      - name: âœ… Verify build output
        run: |
          echo "Checking build output..."
          if [ -d "dist" ]; then
            echo "âœ… dist directory exists"
            echo "ğŸ“Š Build size:"
            du -sh dist/
            echo ""
            echo "ğŸ“ Build contents:"
            ls -lah dist/
          else
            echo "âŒ dist directory NOT found"
            exit 1
          fi
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ steps.version.outputs.version }}
          path: dist/
          retention-days: 30
      
      - name: ğŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
      
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "## ğŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.version.outputs.git_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** ${{ steps.version.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://tryonyou.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vite: $(node -p "require('./package.json').devDependencies.vite")" >> $GITHUB_STEP_SUMMARY
          echo "- React: $(node -p "require('./package.json').dependencies.react")" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ”” Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Live at: https://tryonyou.app"
            echo "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
          else
            echo "âŒ Deployment failed!"
          fi

  lighthouse-audit:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()
    
    steps:
      - name: ğŸ” Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://tryonyou.app
          uploadArtifacts: true
          temporaryPublicStorage: true

