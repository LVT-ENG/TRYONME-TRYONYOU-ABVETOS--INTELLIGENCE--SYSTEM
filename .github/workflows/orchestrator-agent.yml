name: Agent 70 - Orquestador General

on:
  schedule:
    # Run every hour to monitor all agents
    - cron: '0 * * * *'
    # Daily report at 09:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  orchestrator:
    name: General Orchestrator
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      
      - name: ğŸ“Š Check Agent Status
        id: check-agents
        run: |
          echo "## ğŸ¤– Active Agents Status Check" > /tmp/agent-status.md
          echo "" >> /tmp/agent-status.md
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> /tmp/agent-status.md
          echo "" >> /tmp/agent-status.md
          
          # Check if workflows exist
          echo "### Workflow Status:" >> /tmp/agent-status.md
          
          if [ -f ".github/workflows/deploy.yml" ]; then
            echo "- âœ… Agent 22 (Deploy Operator): Active" >> /tmp/agent-status.md
          else
            echo "- âŒ Agent 22 (Deploy Operator): Missing" >> /tmp/agent-status.md
          fi
          
          if [ -f ".github/workflows/github-agent.yml" ]; then
            echo "- âœ… Agent 20 (GitHub Commit Agent): Active" >> /tmp/agent-status.md
          else
            echo "- âš ï¸ Agent 20 (GitHub Commit Agent): Pending" >> /tmp/agent-status.md
          fi
          
          if [ -f ".github/workflows/brand-guardian.yml" ]; then
            echo "- âœ… Agent 12 (Brand Guardian): Active" >> /tmp/agent-status.md
          else
            echo "- âš ï¸ Agent 12 (Brand Guardian): Pending" >> /tmp/agent-status.md
          fi
          
          # Check docs structure
          echo "" >> /tmp/agent-status.md
          echo "### Documentation Status:" >> /tmp/agent-status.md
          
          if [ -d "docs/legal" ]; then
            echo "- âœ… Legal docs: Present" >> /tmp/agent-status.md
          else
            echo "- âŒ Legal docs: Missing" >> /tmp/agent-status.md
          fi
          
          if [ -f "docs/agentes.md" ]; then
            echo "- âœ… Agents documentation: Present" >> /tmp/agent-status.md
          else
            echo "- âŒ Agents documentation: Missing" >> /tmp/agent-status.md
          fi
          
          # Check assets
          echo "" >> /tmp/agent-status.md
          echo "### Assets Status:" >> /tmp/agent-status.md
          
          if [ -d "public/assets" ]; then
            asset_count=$(find public/assets -type f | wc -l)
            echo "- âœ… Assets directory: $asset_count files" >> /tmp/agent-status.md
          else
            echo "- âŒ Assets directory: Missing" >> /tmp/agent-status.md
          fi
          
          cat /tmp/agent-status.md
      
      - name: ğŸ“… Generate Daily Report
        if: github.event.schedule == '0 9 * * *'
        run: |
          echo "## ğŸ“… TRYONYOU Daily Report - $(date -u '+%Y-%m-%d')" > /tmp/daily-report.md
          echo "" >> /tmp/daily-report.md
          echo "### ğŸ¯ Priority Tasks (P0/P1)" >> /tmp/daily-report.md
          echo "" >> /tmp/daily-report.md
          echo "**P0 - Critical:**" >> /tmp/daily-report.md
          echo "- Deploy verification" >> /tmp/daily-report.md
          echo "- Security checks" >> /tmp/daily-report.md
          echo "- Production monitoring" >> /tmp/daily-report.md
          echo "" >> /tmp/daily-report.md
          echo "**P1 - High:**" >> /tmp/daily-report.md
          echo "- Code quality checks" >> /tmp/daily-report.md
          echo "- Documentation updates" >> /tmp/daily-report.md
          echo "- Asset synchronization" >> /tmp/daily-report.md
          echo "" >> /tmp/daily-report.md
          echo "### ğŸ”— Quick Links:" >> /tmp/daily-report.md
          echo "- ğŸŒ Production: https://tryonyou.app" >> /tmp/daily-report.md
          echo "- ğŸ“Š Repository: https://github.com/LVT-ENG/TRYONME-TRYONYOU-ABVETOS--INTELLIGENCE--SYSTEM" >> /tmp/daily-report.md
          echo "- ğŸ“š Docs: https://github.com/LVT-ENG/TRYONME-TRYONYOU-ABVETOS--INTELLIGENCE--SYSTEM/tree/main/docs" >> /tmp/daily-report.md
          echo "" >> /tmp/daily-report.md
          echo "### ğŸ¤– Active Agents:" >> /tmp/daily-report.md
          echo "- Agent 70: Orquestador General âœ…" >> /tmp/daily-report.md
          echo "- Agent 22: Deploy Operator âœ…" >> /tmp/daily-report.md
          echo "- Agent 20: GitHub Commit Agent ğŸ”„" >> /tmp/daily-report.md
          echo "- Agent 12: Brand Guardian ğŸ”„" >> /tmp/daily-report.md
          echo "- Agent 46: Document Locker ğŸ”„" >> /tmp/daily-report.md
          echo "- Agent 2: Content Pro ğŸ”„" >> /tmp/daily-report.md
          echo "- Agent 25: Image Curator ğŸ”„" >> /tmp/daily-report.md
          echo "- Agent 31: Video Curator ğŸ”„" >> /tmp/daily-report.md
          
          cat /tmp/daily-report.md
      
      - name: ğŸ“± Send Daily Telegram Notification
        if: github.event.schedule == '0 9 * * *'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            REPORT=$(cat /tmp/daily-report.md)
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode="Markdown" \
              -d text="$REPORT" || echo "âš ï¸ Telegram notification failed (non-critical)"
            
            echo "âœ… Daily report sent to Telegram"
          else
            echo "âš ï¸ Telegram credentials not configured"
          fi
      
      - name: ğŸ“ Update Agent Status File
        run: |
          mkdir -p docs/agents
          cat > docs/agents/status.md << 'EOF'
          # ğŸ¤– TRYONYOU Agents Status
          
          **Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## Active Agents (24/7)
          
          | Agent ID | Name | Status | Last Check |
          |----------|------|--------|------------|
          | 70 | Orquestador General | ğŸŸ¢ Active | $(date -u '+%H:%M UTC') |
          | 22 | Deploy Operator | ğŸŸ¢ Active | $(date -u '+%H:%M UTC') |
          | 20 | GitHub Commit Agent | ğŸŸ¡ Pending | - |
          | 31 | Video Curator | ğŸŸ¡ Pending | - |
          | 12 | Brand Guardian | ğŸŸ¡ Pending | - |
          | 46 | Document Locker | ğŸŸ¢ Active | $(date -u '+%H:%M UTC') |
          | 2 | Content Pro | ğŸŸ¡ Pending | - |
          | 25 | Image Curator | ğŸŸ¡ Pending | - |
          
          ## System Health
          
          - âœ… Repository: Healthy
          - âœ… CI/CD Pipeline: Active
          - âœ… Documentation: Up-to-date
          - âœ… Assets: Synchronized
          
          ## Next Scheduled Tasks
          
          - Daily report: 09:00 UTC
          - Hourly monitoring: Every hour
          - Deploy on push: Automatic
          
          EOF
          
          # Evaluate the variables
          eval "cat > docs/agents/status.md << 'EOF'
          # ğŸ¤– TRYONYOU Agents Status
          
          **Last updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## Active Agents (24/7)
          
          | Agent ID | Name | Status | Last Check |
          |----------|------|--------|------------|
          | 70 | Orquestador General | ğŸŸ¢ Active | $(date -u '+%H:%M UTC') |
          | 22 | Deploy Operator | ğŸŸ¢ Active | $(date -u '+%H:%M UTC') |
          | 20 | GitHub Commit Agent | ğŸŸ¡ Pending | - |
          | 31 | Video Curator | ğŸŸ¡ Pending | - |
          | 12 | Brand Guardian | ğŸŸ¡ Pending | - |
          | 46 | Document Locker | ğŸŸ¢ Active | $(date -u '+%H:%M UTC') |
          | 2 | Content Pro | ğŸŸ¡ Pending | - |
          | 25 | Image Curator | ğŸŸ¡ Pending | - |
          
          ## System Health
          
          - âœ… Repository: Healthy
          - âœ… CI/CD Pipeline: Active
          - âœ… Documentation: Up-to-date
          - âœ… Assets: Synchronized
          
          ## Next Scheduled Tasks
          
          - Daily report: 09:00 UTC
          - Hourly monitoring: Every hour
          - Deploy on push: Automatic
          
          EOF
          "
      
      - name: ğŸ’¾ Commit Status Updates
        run: |
          git config --global user.name "TRYONYOU Orchestrator"
          git config --global user.email "orchestrator@tryonyou.app"
          
          if [ -f "docs/agents/status.md" ]; then
            git add docs/agents/status.md
            git diff --staged --quiet || git commit -m "ğŸ¤– Agent 70: Update agent status [skip ci]"
            git push || echo "âš ï¸ No changes to push"
          fi
