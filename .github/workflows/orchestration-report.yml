name: System Orchestration Report

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]

jobs:
  orchestration-report:
    name: Generate System Report
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Generate System Status Report
        run: |
          cat > /tmp/system-report.md << EOF
          # ðŸ¤– TRYONYOU System Orchestration Report
          
          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          
          ## ðŸ“Š System Status
          
          ### Active Modules
          - âœ… PAU (Personalized Avatar Unit)
          - âœ… CAP (Collaborative AI Production)
          - âœ… ABVET Payment Gateway
          - âœ… AutoDonate System
          - âœ… Dashboard ABVETOS
          
          ### Deployment Status
          - ðŸŒ **Production URL:** https://tryonyou.app
          - ðŸ”„ **Auto-Deploy:** Active
          - ðŸ“¦ **Build System:** Vite 7.1.2
          - â˜ï¸ **Platform:** Vercel
          
          ### Recent Activity
          - **Last Commit:** ${{ github.sha }}
          - **Last Author:** ${{ github.actor }}
          - **Workflow Run:** ${{ github.run_id }}
          
          ## ðŸ› ï¸ Infrastructure
          
          ### CI/CD Pipelines
          - âœ… Build and Deploy
          - âœ… Auto-update PR
          - âœ… Document Locker
          - âœ… Clean Merge
          - âœ… Brand Guardian
          - âœ… Orchestration Report
          
          ### Monitoring
          - ðŸ“ˆ Performance Metrics: Active
          - ðŸ” Security Scanning: Active
          - ðŸ“Š Analytics: Configured
          
          ## ðŸ“„ Documentation
          
          - Legal: `/docs/legal/`
          - Investors: `/docs/investors/`
          - Dashboard: `/docs/dashboard/`
          
          ## ðŸ”— Quick Links
          
          - [Production Site](https://tryonyou.app)
          - [GitHub Repository](https://github.com/${{ github.repository }})
          - [Actions](https://github.com/${{ github.repository }}/actions)
          
          ---
          
          *Report generated automatically by ABVETOS orchestration system*
          EOF
          
          # Display report
          cat /tmp/system-report.md
      
      - name: Save Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchestration-report-${{ github.run_id }}
          path: /tmp/system-report.md
          retention-days: 30
      
      - name: Send Telegram Report
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="ðŸ¤– *TRYONYOU System Report*
          
          ðŸ“Š *Status:* All Systems Operational
          ðŸŒ *URL:* https://tryonyou.app
          â° *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          âœ… PAU Module: Active
          âœ… CAP Module: Active
          âœ… ABVET Payment: Active
          âœ… AutoDonate: Active
          âœ… Dashboard: Active
          
          ðŸ”„ Auto-deploy: Enabled
          ðŸ“¦ CI/CD: Operational
          
          Full report available in GitHub Actions artifacts."
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode="Markdown" \
              -d text="$MESSAGE"
            
            echo "âœ… Telegram report sent"
          else
            echo "âš ï¸ Telegram credentials not configured"
          fi
