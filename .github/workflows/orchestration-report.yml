name: System Orchestration Report

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]

jobs:
  orchestration-report:
    name: Generate System Report
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Generate System Status Report
        run: |
          cat > /tmp/system-report.md << EOF
          # 🤖 TRYONYOU System Orchestration Report
          
          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          
          ## 📊 System Status
          
          ### Active Modules
          - ✅ PAU (Personalized Avatar Unit)
          - ✅ CAP (Collaborative AI Production)
          - ✅ ABVET Payment Gateway
          - ✅ AutoDonate System
          - ✅ Dashboard ABVETOS
          
          ### Deployment Status
          - 🌐 **Production URL:** https://tryonyou.app
          - 🔄 **Auto-Deploy:** Active
          - 📦 **Build System:** Vite 7.1.2
          - ☁️ **Platform:** Vercel
          
          ### Recent Activity
          - **Last Commit:** ${{ github.sha }}
          - **Last Author:** ${{ github.actor }}
          - **Workflow Run:** ${{ github.run_id }}
          
          ## 🛠️ Infrastructure
          
          ### CI/CD Pipelines
          - ✅ Build and Deploy
          - ✅ Auto-update PR
          - ✅ Document Locker
          - ✅ Clean Merge
          - ✅ Brand Guardian
          - ✅ Orchestration Report
          
          ### Monitoring
          - 📈 Performance Metrics: Active
          - 🔐 Security Scanning: Active
          - 📊 Analytics: Configured
          
          ## 📄 Documentation
          
          - Legal: `/docs/legal/`
          - Investors: `/docs/investors/`
          - Dashboard: `/docs/dashboard/`
          
          ## 🔗 Quick Links
          
          - [Production Site](https://tryonyou.app)
          - [GitHub Repository](https://github.com/${{ github.repository }})
          - [Actions](https://github.com/${{ github.repository }}/actions)
          
          ---
          
          *Report generated automatically by ABVETOS orchestration system*
          EOF
          
          # Display report
          cat /tmp/system-report.md
      
      - name: Save Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchestration-report-${{ github.run_id }}
          path: /tmp/system-report.md
          retention-days: 30
      
      - name: Send Telegram Report
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            MESSAGE="🤖 *TRYONYOU System Report*
          
          📊 *Status:* All Systems Operational
          🌐 *URL:* https://tryonyou.app
          ⏰ *Time:* $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ✅ PAU Module: Active
          ✅ CAP Module: Active
          ✅ ABVET Payment: Active
          ✅ AutoDonate: Active
          ✅ Dashboard: Active
          
          🔄 Auto-deploy: Enabled
          📦 CI/CD: Operational
          
          Full report available in GitHub Actions artifacts."
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode="Markdown" \
              -d text="$MESSAGE"
            
            echo "✅ Telegram report sent"
          else
            echo "⚠️ Telegram credentials not configured"
          fi
