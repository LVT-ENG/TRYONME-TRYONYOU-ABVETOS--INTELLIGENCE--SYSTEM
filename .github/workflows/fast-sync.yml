name: FastSync - Express Auto-Deploy

on:
  schedule:
    # Run every 10 minutes for fast synchronization
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  fast-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üèóÔ∏è Build project
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: üöÄ Deploy to Vercel
        id: vercel-deploy
        run: |
          npm install -g vercel
          vercel --prod --yes --token ${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: üìä Get deployment info
        id: deploy-info
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "deploy_time=$DEPLOY_TIME" >> $GITHUB_OUTPUT
      
      - name: üì± Send Telegram notification
        if: success()
        run: |
          MESSAGE="ü¶ö <b>FastSync - Express Deployment</b>%0A%0A‚úÖ Auto-deployment completed successfully%0A%0Aüîπ <b>Commit:</b> ${{ steps.deploy-info.outputs.commit_hash }}%0A‚è∞ <b>Time:</b> ${{ steps.deploy-info.outputs.deploy_time }}%0Aüåê <b>URL:</b> https://tryonyou.app%0A‚ö° <b>Sync:</b> Every 10 minutes%0A%0A<i>Powered by GitHub Actions FastSync</i>"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=HTML \
            -d text="$MESSAGE"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      
      - name: ‚ùå Notify on failure
        if: failure()
        run: |
          FAILURE_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          MESSAGE="‚ö†Ô∏è <b>FastSync - Deployment Failed</b>%0A%0A‚ùå Scheduled deployment encountered an error%0A%0A‚è∞ <b>Time:</b> $FAILURE_TIME%0A%0APlease check GitHub Actions logs for details."
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=HTML \
            -d text="$MESSAGE"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
