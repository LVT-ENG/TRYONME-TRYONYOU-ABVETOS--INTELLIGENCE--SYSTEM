name: Auto-close Placeholder Issues

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  close-stale-placeholder-issues:
    runs-on: ubuntu-latest
    
    steps:
    - name: Close stale placeholder issues
      uses: actions/github-script@v7
      with:
        script: |
          // Get issues with placeholder label that are older than 48 hours
          const twoDaysAgo = new Date();
          twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
          
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'needs-template-completion',
            state: 'open',
            per_page: 100
          });
          
          console.log(`Found ${issues.length} issues with placeholder label`);
          
          for (const issue of issues) {
            const createdAt = new Date(issue.created_at);
            const updatedAt = new Date(issue.updated_at);
            
            // Check if issue is older than 48 hours and hasn't been updated
            if (createdAt < twoDaysAgo && updatedAt < twoDaysAgo) {
              console.log(`Closing stale placeholder issue #${issue.number}: "${issue.title}"`);
              
              // Add final comment before closing
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ðŸ”’ Auto-closing Placeholder Issue

This issue has been automatically closed because it contains placeholder template content that wasn't replaced within 48 hours.

### To reopen this issue:
1. Edit the title to replace placeholders with specific information
2. Fill in the template body with actual details  
3. Mention @LVT-ENG to request reopening

### Create a new issue:
If you prefer to start fresh, please [create a new issue](../../issues/new/choose) using the appropriate template and remember to replace all placeholder text.

---
*Automated closure by placeholder detection system*`
              });
              
              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'not_planned'
              });
              
              console.log(`âœ… Closed issue #${issue.number}`);
            } else {
              console.log(`Issue #${issue.number} is recent or was updated, keeping open`);
            }
          }
          
          console.log('âœ… Placeholder issue cleanup completed');