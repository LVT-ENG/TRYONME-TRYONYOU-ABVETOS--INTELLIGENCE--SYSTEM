name: ABVETOS Orchestration

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      skip_tests:
        description: 'Skip domain health tests'
        required: false
        default: false
        type: boolean

jobs:
  abvetos-orchestration:
    name: ğŸš€ ABVETOS Full Orchestration
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“Š Repository Info
        run: |
          echo "ğŸ·ï¸ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸ¯ Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "â° Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      - name: ğŸ§¹ ABVET Cleanup Process
        run: |
          echo "ğŸš€ Iniciando orquestaciÃ³n ABVET..."
          chmod +x ./scripts/agent_clean.sh
          ./scripts/agent_clean.sh

      - name: ğŸ“‘ ABVET Documentation Organization
        run: |
          chmod +x ./scripts/agent_docs.sh
          ./scripts/agent_docs.sh

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ“¦ Instalando dependencias npm..."
          npm install

      - name: ğŸ”¨ Build Application
        run: |
          echo "ğŸ”¨ Compilando aplicaciÃ³n..."
          npm run build

      - name: ğŸ‘€ Preview Application
        run: |
          echo "ğŸ‘€ Ejecutando preview..."
          timeout 30s npm run preview || echo "Preview completado o timeout alcanzado"

      - name: â¬†ï¸ ABVET Push Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "ABVETOS Orchestrator"
          git config --global user.email "abvetos-bot@tryonyou.app"
          
          # Execute the ABVET push script
          chmod +x ./scripts/agent_push.sh
          
          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            echo "â¬†ï¸ ABVET: preparando push a GitHub..."
            git add .
            git commit -m "ABVETOS Orchestration: actualizaciÃ³n completa de documentaciÃ³n, limpieza y estructura"
            git push origin ${{ github.ref_name }}
            echo "âœ… ABVET: cambios subidos a GitHub. Vercel desplegarÃ¡ automÃ¡ticamente."
          else
            echo "â„¹ï¸ No hay cambios para commitear"
          fi

      - name: ğŸ§ª ABVET Domain Health Tests
        if: ${{ !github.event.inputs.skip_tests }}
        run: |
          chmod +x ./scripts/agent_test.sh
          ./scripts/agent_test.sh

      - name: ğŸ¯ Deploy to Vercel
        if: success()
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -n "$VERCEL_TOKEN" ]; then
            echo "ğŸš€ Desplegando en Vercel..."
            npx vercel --prod --yes \
              --token=$VERCEL_TOKEN \
              --org-id=$VERCEL_ORG_ID \
              --project-id=$VERCEL_PROJECT_ID || echo "âš ï¸ Deploy opcional fallÃ³"
            echo "âœ… Deploy Tryonme Tryonyou completado"
          else
            echo "âš ï¸ VERCEL_TOKEN no configurado, saltando deploy"
          fi

      - name: ğŸ“Š Orchestration Summary
        if: always()
        run: |
          echo "ğŸ“‹ ABVETOS Orchestration Summary"
          echo "================================"
          echo "ğŸ·ï¸ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "â° Completed at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "ğŸ¯ Status: ${{ job.status }}"
          echo ""
          echo "âœ… OrquestaciÃ³n ABVET completada. Revisa Vercel para confirmar despliegue."

      - name: ğŸ”” Notify on Success
        if: success()
        run: |
          echo "ğŸ‰ ABVETOS Orchestration completed successfully!"
          echo "ğŸŒ Check Vercel dashboard for deployment status"
          echo "ğŸ“Š All domain health checks passed"

      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "âŒ ABVETOS Orchestration failed!"
          echo "ğŸ” Check workflow logs for details"
          echo "ğŸ“ Contact system administrator if issue persists"