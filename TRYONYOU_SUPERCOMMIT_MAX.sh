#!/bin/bash
set -e

echo "ğŸ¦š TRYONYOUâ€“ABVETOSâ€“ULTRAâ€“PLUSâ€“ULTIMATUM â€” SuperCommit MAX"

# 1. Verification
if [ ! -f "package.json" ]; then
    echo "âŒ Error: This script must be run from the repository root."
    exit 1
fi

# 2. Git Synchronization
echo "ğŸ“Œ Switching to branch main..."
git checkout main || { echo "âš ï¸ Switching to main failed, ensuring current branch is valid..."; }
echo "ğŸ“¥ Updating from origin..."
git pull origin main || echo "âš ï¸ Pull failed (might be first push), continuing..."

# 3. Clean & Install (The Purge)
echo "ğŸ§¹ Cleaning obsolete files (node_modules, dist, legacy)..."
rm -rf node_modules dist legacy_old temp_old apps/web-old tests-old legacy integrations/duplicados
echo "ğŸ“¦ Installing fresh dependencies..."
npm install

# 4. Staging Files (The Consolidation)
echo "â• Adding files to staging area..."
git add docs/ || echo "âš ï¸ docs/ not found"
git add src/ || echo "âš ï¸ src/ not found"
git add public/ || echo "âš ï¸ public/ not found"
git add scripts/ || echo "âš ï¸ scripts/ not found"
git add api/ || echo "âš ï¸ api/ not found"

# Config Files
git add package.json package-lock.json vite.config.js vercel.json index.html .env.example .gitignore README.md CHANGELOG.md

# 5. The Ultimatum Commit
echo "ğŸ’ Creating Consolidated SuperCommit..."
git commit -m "ğŸ”¥ TRYONYOUâ€“ABVETOSâ€“ULTRAâ€“PLUSâ€“ULTIMATUM

âœ… Consolidated architecture: Avatar3D, TextileComparator, PAU, CAP, ABVET, Wardrobe, AutoDonate, FTT.
âœ… Integrated Deploy Express + CI/CD (Vercel + Telegram).
âœ… Clean merge of all legacy repositories into unified monorepo.
âœ… Verified ABVET endpoints and PAU recommender.
âœ… Project fully aligned with EPCT patent, production-ready build.

ğŸŒ Domain: tryonyou.app (Vercel + Cloudflare SSL Strict)
ğŸ”— Notifications: @abvet_deploy_bot
ğŸ’ Commit generated by Agente 70 â€” SuperCommit MAX

This commit represents the final integration of all TRYONYOU subsystems into a unified, production-ready platform." || echo "âš ï¸ No new changes to commit"

# 6. Push to Origin
echo "ğŸš€ Pushing changes to origin main..."
git push origin main

# 7. Optional Direct Deploy
# Note: VERCEL_TOKEN should be set as environment variable for security
# Example: export VERCEL_TOKEN=your_token or use Vercel CLI login
if [ -n "$VERCEL_TOKEN" ]; then
    echo "ğŸš€ Triggering Vercel Production Deploy..."
    npx vercel --prod --token="$VERCEL_TOKEN" --yes --force
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… SUPERCOMMIT MAX COMPLETE"
echo "ğŸŒ Verify live site: https://tryonyou.app"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
