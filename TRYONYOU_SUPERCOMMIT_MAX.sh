#!/bin/bash
set -e

echo "ğŸ¦š INICIANDO PROTOCOLO: TRYONYOUâ€“ABVETOSâ€“ULTRAâ€“PLUSâ€“ULTIMATUM"

# 1. VerificaciÃ³n de Seguridad
if [ ! -f "package.json" ]; then
    echo "âŒ Error: Ejecuta esto en la raÃ­z del proyecto (donde estÃ¡ package.json)"
    exit 1
fi

# 2. SincronizaciÃ³n
echo "ğŸ”„ Sincronizando con rama main..."
git checkout main || git checkout -b main
git pull origin main || echo "âš ï¸ No se pudo hacer pull, continuando con local..."

# 3. Limpieza Profunda (Destructiva)
echo "ğŸ§¹ Ejecutando limpieza de arquitectura..."
rm -rf node_modules dist legacy_old temp_old apps/web-old tests-old legacy integrations/duplicados
echo "âœ… Limpieza completada."

# 4. InstalaciÃ³n Fresca
echo "ğŸ“¦ Instalando dependencias (Vite 7.1.2 + React 18.3.1)..."
npm install

# 5. Estructura de Directorios Divineo
echo "ğŸ“‚ Verificando estructura de directorios..."
mkdir -p src/modules/{avatar3D,pau,cap,abvet,wardrobe,ftt}
mkdir -p public/assets/{catalog,branding,ui}
mkdir -p public/docs/{patent,investor}

# 6. Preparar Staging
echo "â• AÃ±adiendo archivos al stage..."
git add .

# 7. COMMIT MAESTRO (DefiniciÃ³n del Ecosistema)
echo "ğŸ’ Generando SuperCommit..."
git commit -m "ğŸ”¥ TRYONYOUâ€“ABVETOSâ€“ULTRAâ€“PLUSâ€“ULTIMATUM

âœ… Consolidated Architecture: Avatar3D, PAU, CAP, ABVET, Wardrobe, FTT.
âœ… Integrated Deploy Express + CI/CD.
âœ… Cleaned legacy repositories & dependencies.
âœ… Legal: Project aligned with Patent PCT/EP2025/067317.

MODULES INTEGRATED:
- PAU (Personal Avatar Unit): Emotional AI Recommendations.
- ABVET: Biometric Payment (Iris/Voice).
- CAP: Just-in-Time Auto-Production.
- Wardrobe: Smart & Solidarity ecosystem.

INFRASTRUCTURE:
- Frontend: Vite 7.1.2 + React 18.3.1
- Deploy: Vercel Production
- SSL: Strict Mode

Commit generated by Agente 70 â€” SuperCommit MAX" || echo "âš ï¸ Nada nuevo que commitear."

# 8. Push a GitHub
echo "ğŸš€ Enviando a GitHub..."
git push origin main

# 9. Despliegue AutomÃ¡tico (Si existe token)
if [ -n "$VERCEL_TOKEN" ]; then
    echo "ğŸŒ Desplegando a Vercel ProducciÃ³n..."
    npx vercel --prod --token=$VERCEL_TOKEN --yes --force
else
    echo "â„¹ï¸ VERCEL_TOKEN no detectado. El cÃ³digo estÃ¡ en GitHub, pero el deploy manual es necesario."
fi

echo "âœ… OPERACIÃ“N COMPLETADA: El sistema estÃ¡ sincronizado."
