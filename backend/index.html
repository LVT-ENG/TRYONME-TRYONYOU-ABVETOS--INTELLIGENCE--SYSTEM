<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRYONYOU ‚Äì Medici√≥n autom√°tica por c√°mara</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0A0A0A 0%, #1A1A2E 50%, #003459 100%);
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      width: 100%;
    }

    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #00A8E8 0%, #D4AF37 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.05em;
    }

    .subtitle {
      text-align: center;
      color: #8B92A0;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    #videoElement {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }

    #canvasElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(135deg, #00A8E8 0%, #003459 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 140px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 168, 232, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    button.secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    button.success {
      background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }

    .measurements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .measurement-item {
      background: rgba(0, 168, 232, 0.1);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid rgba(0, 168, 232, 0.2);
    }

    .measurement-label {
      font-size: 0.9rem;
      color: #8B92A0;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .measurement-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #00A8E8;
    }

    .measurement-unit {
      font-size: 1rem;
      color: #D4AF37;
      margin-left: 4px;
    }

    .status {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }

    .status.info {
      background: rgba(0, 168, 232, 0.2);
      border: 1px solid rgba(0, 168, 232, 0.4);
      color: #00A8E8;
    }

    .status.success {
      background: rgba(40, 167, 69, 0.2);
      border: 1px solid rgba(40, 167, 69, 0.4);
      color: #28a745;
    }

    .status.error {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid rgba(220, 53, 69, 0.4);
      color: #dc3545;
    }

    .instructions {
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .instructions h3 {
      color: #D4AF37;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .instructions ul {
      list-style: none;
      padding-left: 0;
    }

    .instructions li {
      padding: 6px 0;
      color: #C0C0C0;
    }

    .instructions li::before {
      content: "‚úì ";
      color: #D4AF37;
      font-weight: bold;
      margin-right: 8px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 168, 232, 0.3);
      border-radius: 50%;
      border-top-color: #00A8E8;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .height-input-container {
      margin-bottom: 20px;
    }

    .height-input-container label {
      display: block;
      margin-bottom: 8px;
      color: #8B92A0;
      font-weight: 500;
    }

    .height-input-container input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: white;
      font-size: 16px;
    }

    .height-input-container input:focus {
      outline: none;
      border-color: #00A8E8;
    }

    .recommendation-card {
      background: linear-gradient(135deg, rgba(0, 168, 232, 0.15) 0%, rgba(0, 52, 89, 0.15) 100%);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(0, 168, 232, 0.3);
      margin-top: 20px;
    }

    .recommendation-card h3 {
      color: #D4AF37;
      margin-bottom: 16px;
    }

    .recommendation-details {
      display: grid;
      gap: 12px;
    }

    .recommendation-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .recommendation-item:last-child {
      border-bottom: none;
    }

    .recommendation-label {
      color: #8B92A0;
    }

    .recommendation-value {
      color: #00A8E8;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>TRYONYOU</h1>
    <div class="subtitle">Medici√≥n autom√°tica por c√°mara</div>

    <div class="main-grid">
      <!-- Video and Controls Section -->
      <div class="card">
        <div class="video-container">
          <video id="videoElement" autoplay playsinline></video>
          <canvas id="canvasElement"></canvas>
        </div>

        <div class="controls">
          <button id="startButton">Iniciar C√°mara</button>
          <button id="captureButton" disabled>Capturar Medidas</button>
          <button id="stopButton" class="secondary" disabled>Detener C√°mara</button>
        </div>

        <div id="statusMessage" class="status info">
          Presiona "Iniciar C√°mara" para comenzar
        </div>

        <div class="instructions">
          <h3>üìã Instrucciones:</h3>
          <ul>
            <li>P√°rate a 2-3 metros de la c√°mara</li>
            <li>Aseg√∫rate de estar completamente visible</li>
            <li>Mant√©n una postura recta con brazos a los lados</li>
            <li>Buena iluminaci√≥n es importante</li>
            <li>Ingresa tu altura real para mayor precisi√≥n</li>
          </ul>
        </div>
      </div>

      <!-- Measurements Section -->
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #00A8E8;">üìè Medidas Corporales</h2>

        <div class="height-input-container">
          <label for="heightInput">Altura Real (cm):</label>
          <input type="number" id="heightInput" placeholder="Ej: 175" min="140" max="220" step="0.1">
        </div>

        <div class="measurements-grid" id="measurementsGrid">
          <div class="measurement-item">
            <div class="measurement-label">Altura</div>
            <div class="measurement-value">
              <span id="heightValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
          <div class="measurement-item">
            <div class="measurement-label">Pecho</div>
            <div class="measurement-value">
              <span id="chestValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
          <div class="measurement-item">
            <div class="measurement-label">Cintura</div>
            <div class="measurement-value">
              <span id="waistValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
          <div class="measurement-item">
            <div class="measurement-label">Cadera</div>
            <div class="measurement-value">
              <span id="hipValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
          <div class="measurement-item">
            <div class="measurement-label">Ancho Hombros</div>
            <div class="measurement-value">
              <span id="shoulderValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
          <div class="measurement-item">
            <div class="measurement-label">Largo Brazos</div>
            <div class="measurement-value">
              <span id="armValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
          <div class="measurement-item">
            <div class="measurement-label">Largo Piernas</div>
            <div class="measurement-value">
              <span id="legValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
          <div class="measurement-item">
            <div class="measurement-label">Largo Torso</div>
            <div class="measurement-value">
              <span id="torsoValue">--</span>
              <span class="measurement-unit">cm</span>
            </div>
          </div>
        </div>

        <button id="sendButton" class="success" style="width: 100%; margin-top: 20px;" disabled>
          Enviar Medidas al Sistema
        </button>

        <div id="recommendationContainer" style="display: none;">
          <div class="recommendation-card">
            <h3>üéØ Recomendaci√≥n de Prenda</h3>
            <div class="recommendation-details" id="recommendationDetails">
              <!-- Recommendation details will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MediaPipe Pose Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

  <script>
    // Configuration
    const API_BASE_URL = window.location.origin.includes('localhost') ? 'http://127.0.0.1:5000' : window.location.origin;

    // DOM Elements
    const videoElement = document.getElementById('videoElement');
    const canvasElement = document.getElementById('canvasElement');
    const canvasCtx = canvasElement.getContext('2d');
    const startButton = document.getElementById('startButton');
    const captureButton = document.getElementById('captureButton');
    const stopButton = document.getElementById('stopButton');
    const sendButton = document.getElementById('sendButton');
    const statusMessage = document.getElementById('statusMessage');
    const heightInput = document.getElementById('heightInput');

    // State
    let camera = null;
    let pose = null;
    let measurements = null;
    let isCapturing = false;

    // Update status message
    function updateStatus(message, type = 'info') {
      statusMessage.textContent = message;
      statusMessage.className = `status ${type}`;
    }

    // Calculate distance between two points
    function calculateDistance(point1, point2) {
      const dx = point1.x - point2.x;
      const dy = point1.y - point2.y;
      const dz = (point1.z || 0) - (point2.z || 0);
      return Math.sqrt(dx * dx + dy * dy + dz * dz);
    }

    // Calculate body measurements from pose landmarks
    function calculateMeasurements(landmarks, imageWidth, imageHeight) {
      // Get real height from input or use default
      const realHeight = parseFloat(heightInput.value) || 170;

      // Calculate pixel height (head to ankle)
      const headY = Math.min(landmarks[0].y, landmarks[7].y, landmarks[8].y);
      const ankleY = Math.max(landmarks[27].y, landmarks[28].y);
      const pixelHeight = (ankleY - headY) * imageHeight;

      // Calculate conversion factor (cm per pixel)
      const cmPerPixel = realHeight / pixelHeight;

      // Shoulder width (left shoulder to right shoulder)
      const shoulderWidth = calculateDistance(landmarks[11], landmarks[12]) * imageWidth * cmPerPixel;

      // Chest circumference (approximate from shoulder and torso width)
      const chestWidth = calculateDistance(landmarks[11], landmarks[12]) * imageWidth * cmPerPixel;
      const chest = chestWidth * 2.8; // Approximation for circumference

      // Waist circumference (approximate from hip width at waist level)
      const waistWidth = calculateDistance(landmarks[23], landmarks[24]) * imageWidth * cmPerPixel * 0.85;
      const waist = waistWidth * 2.8;

      // Hip circumference
      const hipWidth = calculateDistance(landmarks[23], landmarks[24]) * imageWidth * cmPerPixel;
      const hip = hipWidth * 2.8;

      // Arm length (shoulder to wrist)
      const leftArmLength = (
        calculateDistance(landmarks[11], landmarks[13]) +
        calculateDistance(landmarks[13], landmarks[15])
      ) * imageWidth * cmPerPixel;

      const rightArmLength = (
        calculateDistance(landmarks[12], landmarks[14]) +
        calculateDistance(landmarks[14], landmarks[16])
      ) * imageWidth * cmPerPixel;

      const armLength = (leftArmLength + rightArmLength) / 2;

      // Leg length (hip to ankle)
      const leftLegLength = (
        calculateDistance(landmarks[23], landmarks[25]) +
        calculateDistance(landmarks[25], landmarks[27])
      ) * imageHeight * cmPerPixel;

      const rightLegLength = (
        calculateDistance(landmarks[24], landmarks[26]) +
        calculateDistance(landmarks[26], landmarks[28])
      ) * imageHeight * cmPerPixel;

      const legLength = (leftLegLength + rightLegLength) / 2;

      // Torso length (shoulder to hip)
      const torsoLength = (
        calculateDistance(landmarks[11], landmarks[23]) +
        calculateDistance(landmarks[12], landmarks[24])
      ) / 2 * imageHeight * cmPerPixel;

      return {
        height: realHeight,
        chest: Math.round(chest * 10) / 10,
        waist: Math.round(waist * 10) / 10,
        hip: Math.round(hip * 10) / 10,
        shoulder_width: Math.round(shoulderWidth * 10) / 10,
        arm_length: Math.round(armLength * 10) / 10,
        leg_length: Math.round(legLength * 10) / 10,
        torso_length: Math.round(torsoLength * 10) / 10
      };
    }

    // Display measurements
    function displayMeasurements(m) {
      document.getElementById('heightValue').textContent = m.height.toFixed(1);
      document.getElementById('chestValue').textContent = m.chest.toFixed(1);
      document.getElementById('waistValue').textContent = m.waist.toFixed(1);
      document.getElementById('hipValue').textContent = m.hip.toFixed(1);
      document.getElementById('shoulderValue').textContent = m.shoulder_width.toFixed(1);
      document.getElementById('armValue').textContent = m.arm_length.toFixed(1);
      document.getElementById('legValue').textContent = m.leg_length.toFixed(1);
      document.getElementById('torsoValue').textContent = m.torso_length.toFixed(1);

      sendButton.disabled = false;
    }

    // Process pose results
    function onPoseResults(results) {
      // Set canvas size to match video
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;

      // Clear canvas
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      // Draw pose landmarks
      if (results.poseLandmarks) {
        // Draw connections
        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
          color: '#00A8E8',
          lineWidth: 4
        });

        // Draw landmarks
        drawLandmarks(canvasCtx, results.poseLandmarks, {
          color: '#D4AF37',
          lineWidth: 2,
          radius: 6
        });

        // Capture measurements if button was pressed
        if (isCapturing) {
          try {
            measurements = calculateMeasurements(
              results.poseLandmarks,
              canvasElement.width,
              canvasElement.height
            );
            displayMeasurements(measurements);
            updateStatus('Medidas capturadas exitosamente', 'success');
            isCapturing = false;
          } catch (error) {
            console.error('Error calculating measurements:', error);
            updateStatus('Error al calcular medidas. Intenta de nuevo.', 'error');
            isCapturing = false;
          }
        }
      }

      canvasCtx.restore();
    }

    // Initialize MediaPipe Pose
    function initPose() {
      pose = new Pose({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }
      });

      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        smoothSegmentation: false,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      pose.onResults(onPoseResults);
    }

    // Start camera
    async function startCamera() {
      try {
        updateStatus('Iniciando c√°mara...', 'info');

        if (!pose) {
          initPose();
        }

        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          }
        });

        videoElement.srcObject = stream;

        camera = new Camera(videoElement, {
          onFrame: async () => {
            await pose.send({ image: videoElement });
          },
          width: 1280,
          height: 720
        });

        await camera.start();

        startButton.disabled = true;
        captureButton.disabled = false;
        stopButton.disabled = false;

        updateStatus('C√°mara activa - Posici√≥nate seg√∫n las instrucciones', 'success');
      } catch (error) {
        console.error('Error starting camera:', error);
        updateStatus('Error al iniciar la c√°mara. Verifica los permisos.', 'error');
      }
    }

    // Stop camera
    function stopCamera() {
      if (camera) {
        camera.stop();
        camera = null;
      }

      if (videoElement.srcObject) {
        videoElement.srcObject.getTracks().forEach(track => track.stop());
        videoElement.srcObject = null;
      }

      startButton.disabled = false;
      captureButton.disabled = true;
      stopButton.disabled = true;

      updateStatus('C√°mara detenida', 'info');
    }

    // Capture measurements
    function captureMeasurements() {
      if (!heightInput.value) {
        updateStatus('Por favor, ingresa tu altura real primero', 'error');
        heightInput.focus();
        return;
      }

      isCapturing = true;
      captureButton.disabled = true;
      updateStatus('Capturando medidas...', 'info');

      setTimeout(() => {
        if (isCapturing) {
          updateStatus('No se detect√≥ pose. Aseg√∫rate de estar completamente visible.', 'error');
          isCapturing = false;
          captureButton.disabled = false;
        }
      }, 3000);

      setTimeout(() => {
        captureButton.disabled = false;
      }, 3500);
    }

    // Send measurements to API
    async function sendMeasurements() {
      if (!measurements) {
        updateStatus('Primero captura las medidas', 'error');
        return;
      }

      try {
        updateStatus('Enviando medidas al sistema...', 'info');
        sendButton.disabled = true;

        // Send to backend for recommendation
        const response = await fetch(`${API_BASE_URL}/api/recommend`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            measurements: measurements,
            conversation: {
              occasion: 'work',
              fit_preference: 'regular'
            }
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const recommendation = await response.json();

        // Display recommendation
        displayRecommendation(recommendation);

        updateStatus('Recomendaci√≥n recibida exitosamente', 'success');
      } catch (error) {
        console.error('Error sending measurements:', error);
        updateStatus('Error al enviar medidas. Verifica que el servidor est√© activo.', 'error');
        sendButton.disabled = false;
      }
    }

    // Display recommendation
    function displayRecommendation(rec) {
      const container = document.getElementById('recommendationContainer');
      const details = document.getElementById('recommendationDetails');

      details.innerHTML = `
        <div class="recommendation-item">
          <span class="recommendation-label">Prenda:</span>
          <span class="recommendation-value">${rec.garment_name}</span>
        </div>
        <div class="recommendation-item">
          <span class="recommendation-label">Marca:</span>
          <span class="recommendation-value">${rec.brand}</span>
        </div>
        <div class="recommendation-item">
          <span class="recommendation-label">Talla:</span>
          <span class="recommendation-value">${rec.size}</span>
        </div>
        <div class="recommendation-item">
          <span class="recommendation-label">Ajuste:</span>
          <span class="recommendation-value">${(rec.fit_score * 100).toFixed(1)}%</span>
        </div>
        <div class="recommendation-item">
          <span class="recommendation-label">Color:</span>
          <span class="recommendation-value">${rec.color}</span>
        </div>
        <div class="recommendation-item">
          <span class="recommendation-label">Material:</span>
          <span class="recommendation-value">${rec.material}</span>
        </div>
        <div style="margin-top: 16px; padding: 12px; background: rgba(0, 168, 232, 0.1); border-radius: 8px;">
          <strong style="color: #D4AF37;">Explicaci√≥n:</strong>
          <p style="margin-top: 8px; color: #C0C0C0; line-height: 1.6;">${rec.explanation}</p>
        </div>
      `;

      container.style.display = 'block';
    }

    // Event listeners
    startButton.addEventListener('click', startCamera);
    stopButton.addEventListener('click', stopCamera);
    captureButton.addEventListener('click', captureMeasurements);
    sendButton.addEventListener('click', sendMeasurements);

    // Initialize on page load
    window.addEventListener('load', () => {
      console.log('TRYONYOU Measurement System Loaded');
      console.log('API Base URL:', API_BASE_URL);
    });
  </script>
</body>
</html>
